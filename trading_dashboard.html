<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Trading System - Debug Mode</title>
    
    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0a0e1a;
            color: #e4e4e7;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1e2e 0%, #252a3e 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .dropdown {
            background: #252a3e;
            border: 1px solid #3a3f5c;
            color: #e4e4e7;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            min-width: 120px;
        }
        
        .price-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .price-label {
            font-size: 12px;
            color: #8892a6;
        }
        
        .price-value {
            font-size: 24px;
            font-weight: 700;
            color: #00d4ff;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .status-connected {
            background: #00ff8820;
            color: #00ff88;
            border: 1px solid #00ff8840;
        }
        
        .status-disconnected {
            background: #ff386020;
            color: #ff3860;
            border: 1px solid #ff386040;
        }
        
        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            height: calc(100vh - 70px);
            gap: 20px;
            padding: 20px;
        }
        
        .chart-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .indicator-buttons {
            display: flex;
            gap: 10px;
        }
        
        .indicator-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #3a3f5c;
            background: #1a1e2e;
            color: #8892a6;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .indicator-btn.active {
            background: #00d4ff20;
            color: #00d4ff;
            border-color: #00d4ff40;
        }
        
        .indicator-btn:hover {
            border-color: #00d4ff;
        }
        
        #chart {
            background: #1a1e2e;
            border-radius: 12px;
            border: 1px solid #252a3e;
            height: 500px;
            position: relative;
        }
        
        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel {
            background: #1a1e2e;
            border-radius: 12px;
            border: 1px solid #252a3e;
            padding: 20px;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Price Levels */
        .levels-section {
            margin-bottom: 20px;
        }
        
        .levels-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #8892a6;
        }
        
        .level-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #252a3e;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid;
            transition: all 0.3s ease;
        }
        
        .level-item:hover {
            background: #2a2f44;
        }
        
        .resistance-level {
            border-left-color: #ff3860;
        }
        
        .support-level {
            border-left-color: #00ff88;
        }
        
        .level-label {
            font-weight: 600;
            font-size: 14px;
        }
        
        .level-price {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        /* ML Prediction */
        .ml-prediction {
            background: linear-gradient(135deg, #00d4ff20, #00ff8820);
            border: 2px solid #00d4ff;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .prediction-label {
            font-size: 14px;
            color: #8892a6;
            margin-bottom: 10px;
        }
        
        .prediction-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .prediction-buy { color: #00ff88; }
        .prediction-sell { color: #ff3860; }
        .prediction-hold { color: #ffd700; }
        
        .confidence-container {
            margin-top: 15px;
        }
        
        .confidence-label {
            font-size: 14px;
            color: #8892a6;
            margin-bottom: 8px;
        }
        
        .confidence-bar {
            width: 100%;
            height: 10px;
            background: #252a3e;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        /* Fundamental Events */
        .event-item {
            padding: 15px;
            background: #252a3e;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .event-item:hover {
            background: #2a2f44;
        }
        
        .event-high { border-left-color: #ff3860; }
        .event-medium { border-left-color: #ff9800; }
        .event-low { border-left-color: #4caf50; }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .event-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .impact-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .impact-high {
            background: #ff386020;
            color: #ff3860;
        }
        
        .impact-medium {
            background: #ff980020;
            color: #ff9800;
        }
        
        .impact-low {
            background: #4caf5020;
            color: #4caf50;
        }
        
        .event-details {
            font-size: 13px;
            color: #8892a6;
            line-height: 1.6;
        }
        
        /* Loading and Error States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 18px;
            color: #8892a6;
        }
        
        .error {
            background: #ff386020;
            border: 1px solid #ff3860;
            color: #ff3860;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
        }
        
        /* Debug Panel */
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1a1e2e;
            border: 2px solid #00d4ff;
            padding: 20px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }
        
        .debug-panel.hidden {
            display: none;
        }
        
        .debug-title {
            font-weight: 700;
            margin-bottom: 15px;
            color: #00d4ff;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .debug-close {
            cursor: pointer;
            color: #ff3860;
            font-weight: bold;
        }
        
        .debug-section {
            margin-bottom: 15px;
            padding: 10px;
            background: #252a3e;
            border-radius: 5px;
        }
        
        .debug-section-title {
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 5px;
        }
        
        .debug-line {
            margin: 2px 0;
            color: #8892a6;
            word-break: break-all;
        }
        
        .debug-error {
            color: #ff3860;
        }
        
        .debug-success {
            color: #00ff88;
        }
        
        .debug-warning {
            color: #ff9800;
        }
        
        /* Raw Data Display */
        .raw-data {
            background: #0a0e1a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 11px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="logo">
                📊 Advanced Trading System
            </div>
            <div class="header-controls">
                <select class="dropdown" id="symbolSelect">
                    <option value="EURUSD">EUR/USD</option>
                    <option value="GBPUSD">GBP/USD</option>
                    <option value="USDJPY">USD/JPY</option>
                    <option value="USDCHF">USD/CHF</option>
                    <option value="AUDUSD">AUD/USD</option>
                    <option value="USDCAD">USD/CAD</option>
                </select>
                <select class="dropdown" id="timeframeSelect">
                    <option value="1">1M</option>
                    <option value="5">5M</option>
                    <option value="15" selected>15M</option>
                    <option value="30">30M</option>
                    <option value="60">1H</option>
                    <option value="240">4H</option>
                    <option value="1440">D1</option>
                </select>
            </div>
        </div>
        <div class="header-right" style="display: flex; gap: 30px; align-items: center;">
            <div class="price-display">
                <span class="price-label">Current Price</span>
                <span class="price-value" id="currentPrice">-</span>
            </div>
            <div class="status-indicator status-disconnected" id="connectionStatus">
                <span style="font-size: 10px;">●</span> Disconnected
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Chart Section -->
        <div class="chart-section">
            <div class="chart-header">
                <h2 class="chart-title">📈 Advanced Chart Analysis</h2>
                <div class="indicator-buttons">
                    <button class="indicator-btn active" data-indicator="levels">S/R Levels</button>
                    <button class="indicator-btn active" data-indicator="supertrend">SuperTrend</button>
                    <button class="indicator-btn" data-indicator="wicks">Fresh Wicks</button>
                </div>
            </div>
            <div id="chart">
                <div class="loading">Loading chart data...</div>
            </div>
            
            <!-- ML Prediction -->
            <div class="ml-prediction" id="mlPrediction">
                <div class="prediction-label">Machine Learning Prediction</div>
                <div class="prediction-value prediction-hold" id="predictionAction">-</div>
                <div class="confidence-container">
                    <div class="confidence-label">Confidence: <span id="confidenceValue">-</span>%</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Price Levels Panel -->
            <div class="panel">
                <h3 class="panel-title">📍 Key Price Levels</h3>
                
                <div class="levels-section">
                    <div class="levels-title">Resistance Levels</div>
                    <div id="resistanceLevels">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
                
                <div class="levels-section">
                    <div class="levels-title">Support Levels</div>
                    <div id="supportLevels">
                        <div class="loading">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Fundamental Analysis Panel -->
            <div class="panel">
                <h3 class="panel-title">📰 Fundamental Analysis</h3>
                <div id="fundamentalEvents">
                    <div class="loading">Loading events...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel">
        <div class="debug-title">
            Debug Dashboard
            <span class="debug-close" onclick="toggleDebugPanel()">×</span>
        </div>
        
        <div class="debug-section">
            <div class="debug-section-title">🔧 System State</div>
            <div id="systemState"></div>
        </div>
        
        <div class="debug-section">
            <div class="debug-section-title">📊 Chart State</div>
            <div id="chartState"></div>
        </div>
        
        <div class="debug-section">
            <div class="debug-section-title">📡 Last API Response</div>
            <div id="apiResponse"></div>
        </div>
        
        <div class="debug-section">
            <div class="debug-section-title">🎯 Current Data</div>
            <div id="currentData"></div>
        </div>
        
        <div class="debug-section">
            <div class="debug-section-title">📝 Event Log</div>
            <div id="eventLog"></div>
        </div>
    </div>
    
    <script>
        // ============================================
        // CONFIGURATION & GLOBAL VARIABLES
        // ============================================
        
        // Debug mode - can be controlled by URL parameter or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const DEBUG_MODE = urlParams.get('debug') === 'true' || localStorage.getItem('DEBUG_MODE') === 'true';
        
        // Global state variables
        let chart = null;
        let candlestickSeries = null;
        let currentSymbol = 'EURUSD';
        let currentTimeframe = 15;
        let indicators = {
            levels: true,
            supertrend: true,
            wicks: false
        };
        let levelLines = [];
        let updateInterval = null;
        let lastDataTimestamp = null;
        let isFirstLoad = true;
        let lastApiResponse = null;
        let chartInitialized = false;
        let dataHistory = [];
        let errorCount = 0;
        let successCount = 0;
        
        // ============================================
        // DEBUG LOGGING SYSTEM
        // ============================================
        
        const LogLevel = {
            ERROR: 'error',
            WARNING: 'warning',
            SUCCESS: 'success',
            INFO: 'info',
            DEBUG: 'debug'
        };
        
        function log(level, message, data = null) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp,
                level,
                message,
                data
            };
            
            // Always log to console
            const consoleMethod = level === LogLevel.ERROR ? 'error' : 
                                 level === LogLevel.WARNING ? 'warn' : 
                                 'log';
            
            console[consoleMethod](`[${timestamp}] [${level.toUpperCase()}] ${message}`, data || '');
            
            // Store in history
            if (DEBUG_MODE) {
                addToEventLog(level, message, data);
                updateDebugPanel();
            }
        }
        
        function addToEventLog(level, message, data) {
            const eventLog = document.getElementById('eventLog');
            if (!eventLog) return;
            
            const entry = document.createElement('div');
            entry.className = `debug-line debug-${level}`;
            entry.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            
            if (data && typeof data === 'object') {
                const dataStr = JSON.stringify(data, null, 2);
                if (dataStr.length < 100) {
                    entry.innerHTML += ` - ${dataStr}`;
                }
            }
            
            eventLog.insertBefore(entry, eventLog.firstChild);
            
            // Keep only last 20 entries
            while (eventLog.children.length > 20) {
                eventLog.removeChild(eventLog.lastChild);
            }
        }
        
        // ============================================
        // DEBUG PANEL FUNCTIONS
        // ============================================
        
        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            panel.classList.toggle('hidden');
            localStorage.setItem('DEBUG_PANEL_HIDDEN', panel.classList.contains('hidden'));
        }
        
        function updateDebugPanel() {
            if (!DEBUG_MODE) return;
            
            // System State
            document.getElementById('systemState').innerHTML = `
                <div class="debug-line">Symbol: <strong>${currentSymbol}</strong></div>
                <div class="debug-line">Timeframe: <strong>${currentTimeframe}M</strong></div>
                <div class="debug-line">Chart Initialized: <strong class="${chartInitialized ? 'debug-success' : 'debug-error'}">${chartInitialized}</strong></div>
                <div class="debug-line">Auto-Update: <strong class="${updateInterval ? 'debug-success' : 'debug-error'}">${updateInterval ? 'Active' : 'Inactive'}</strong></div>
                <div class="debug-line">Success/Error: <strong>${successCount}/${errorCount}</strong></div>
            `;
            
            // Chart State
            document.getElementById('chartState').innerHTML = `
                <div class="debug-line">Series Created: <strong>${candlestickSeries ? 'Yes' : 'No'}</strong></div>
                <div class="debug-line">Last Timestamp: <strong>${lastDataTimestamp ? new Date(lastDataTimestamp * 1000).toLocaleString() : 'None'}</strong></div>
                <div class="debug-line">Level Lines: <strong>${levelLines.length}</strong></div>
                <div class="debug-line">Data Points: <strong>${dataHistory.length}</strong></div>
                <div class="debug-line">Indicators: <strong>${JSON.stringify(indicators)}</strong></div>
            `;
            
            // API Response
            if (lastApiResponse) {
                document.getElementById('apiResponse').innerHTML = `
                    <div class="debug-line">Success: <strong class="${lastApiResponse.success ? 'debug-success' : 'debug-error'}">${lastApiResponse.success}</strong></div>
                    <div class="debug-line">OHLC Count: <strong>${lastApiResponse.ohlc?.length || 0}</strong></div>
                    <div class="debug-line">Has Levels: <strong>${lastApiResponse.levels ? 'Yes' : 'No'}</strong></div>
                    <div class="debug-line">Current Price: <strong>${lastApiResponse.currentPrice?.toFixed(5) || 'N/A'}</strong></div>
                    <details>
                        <summary>Raw Response</summary>
                        <div class="raw-data">${JSON.stringify(lastApiResponse, null, 2)}</div>
                    </details>
                `;
            }
            
            // Current Data
            if (dataHistory.length > 0) {
                const lastData = dataHistory[dataHistory.length - 1];
                document.getElementById('currentData').innerHTML = `
                    <div class="debug-line">Time: <strong>${new Date(lastData.time * 1000).toLocaleString()}</strong></div>
                    <div class="debug-line">Open: <strong>${lastData.open}</strong></div>
                    <div class="debug-line">High: <strong>${lastData.high}</strong></div>
                    <div class="debug-line">Low: <strong>${lastData.low}</strong></div>
                    <div class="debug-line">Close: <strong>${lastData.close}</strong></div>
                `;
            }
        }
        
        // ============================================
        // CHART INITIALIZATION
        // ============================================
        
        function initializeChart() {
            try {
                log(LogLevel.INFO, 'Initializing TradingView Lightweight Chart');
                
                const chartContainer = document.getElementById('chart');
                chartContainer.innerHTML = ''; // Clear loading message
                
                const chartOptions = {
                    width: chartContainer.clientWidth,
                    height: chartContainer.clientHeight,
                    layout: {
                        background: { color: '#1a1e2e' },
                        textColor: '#d1d4dc',
                        fontSize: 12
                    },
                    grid: {
                        vertLines: { color: '#252a3e' },
                        horzLines: { color: '#252a3e' }
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal
                    },
                    rightPriceScale: {
                        borderColor: '#252a3e',
                        scaleMargins: {
                            top: 0.1,
                            bottom: 0.1
                        }
                    },
                    timeScale: {
                        borderColor: '#252a3e',
                        timeVisible: true,
                        secondsVisible: false
                    }
                };
                
                log(LogLevel.DEBUG, 'Chart options', chartOptions);
                
                chart = LightweightCharts.createChart(chartContainer, chartOptions);
                
                // Add candlestick series
                candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#00ff88',
                    downColor: '#ff3860',
                    borderVisible: true,
                    wickUpColor: '#00ff88',
                    wickDownColor: '#ff3860'
                });
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    chart.applyOptions({
                        width: chartContainer.clientWidth,
                        height: chartContainer.clientHeight
                    });
                    log(LogLevel.DEBUG, 'Chart resized');
                });
                
                chartInitialized = true;
                log(LogLevel.SUCCESS, 'Chart initialized successfully');
                
            } catch (error) {
                chartInitialized = false;
                log(LogLevel.ERROR, 'Failed to initialize chart', error);
                showError('Failed to initialize chart: ' + error.message);
            }
        }
        
        // ============================================
        // CHART UPDATE FUNCTIONS
        // ============================================
        
        function updateChart(ohlcData) {
            log(LogLevel.INFO, `Updating chart with ${ohlcData?.length || 0} candles`);
            
            if (!candlestickSeries) {
                log(LogLevel.ERROR, 'CandlestickSeries not initialized');
                showError('Chart not initialized');
                return;
            }
            
            if (!ohlcData || ohlcData.length === 0) {
                log(LogLevel.WARNING, 'No OHLC data to display');
                showError('No market data available');
                return;
            }
            
            try {
                // Log first and last candle for debugging
                log(LogLevel.DEBUG, 'First candle', ohlcData[0]);
                log(LogLevel.DEBUG, 'Last candle', ohlcData[ohlcData.length - 1]);
                
                // Convert data format for TradingView
                const candleData = ohlcData.map((candle, index) => {
                    const converted = {
                        time: Math.floor(new Date(candle.time).getTime() / 1000),
                        open: parseFloat(candle.open),
                        high: parseFloat(candle.high),
                        low: parseFloat(candle.low),
                        close: parseFloat(candle.close)
                    };
                    
                    // Validate data
                    if (isNaN(converted.time) || isNaN(converted.open) || 
                        isNaN(converted.high) || isNaN(converted.low) || isNaN(converted.close)) {
                        log(LogLevel.ERROR, `Invalid candle data at index ${index}`, candle);
                        return null;
                    }
                    
                    return converted;
                }).filter(candle => candle !== null).sort((a, b) => a.time - b.time);
                
                log(LogLevel.INFO, `Processed ${candleData.length} valid candles`);
                
                if (candleData.length > 0) {
                    dataHistory = candleData; // Store for debugging
                    
                    if (isFirstLoad || !lastDataTimestamp) {
                        // First load - use setData
                        log(LogLevel.INFO, 'Initial data load - using setData()');
                        candlestickSeries.setData(candleData);
                        chart.timeScale().fitContent();
                        isFirstLoad = false;
                    } else {
                        // Update existing data
                        const lastCandle = candleData[candleData.length - 1];
                        
                        log(LogLevel.DEBUG, `Last timestamp: ${lastDataTimestamp}, New timestamp: ${lastCandle.time}`);
                        
                        if (lastCandle.time > lastDataTimestamp) {
                            // New candle
                            log(LogLevel.SUCCESS, 'Adding new candle');
                            candlestickSeries.update(lastCandle);
                        } else if (lastCandle.time === lastDataTimestamp) {
                            // Update existing candle
                            log(LogLevel.INFO, 'Updating existing candle');
                            candlestickSeries.update(lastCandle);
                        }
                        
                        // Update recent candles
                        const recentCandles = candleData.slice(-10);
                        recentCandles.forEach(candle => {
                            candlestickSeries.update(candle);
                        });
                    }
                    
                    lastDataTimestamp = candleData[candleData.length - 1].time;
                    successCount++;
                } else {
                    log(LogLevel.ERROR, 'No valid candle data after processing');
                    showError('Invalid market data format');
                    errorCount++;
                }
            } catch (error) {
                log(LogLevel.ERROR, 'Error updating chart', error);
                showError('Failed to update chart: ' + error.message);
                errorCount++;
            }
        }
        
        // ============================================
        // LEVEL UPDATE FUNCTIONS
        // ============================================
        
        function updateLevels(levels) {
            log(LogLevel.INFO, 'Updating support/resistance levels', levels);
            
            // Clear existing DOM elements
            const resistanceContainer = document.getElementById('resistanceLevels');
            const supportContainer = document.getElementById('supportLevels');
            resistanceContainer.innerHTML = '';
            supportContainer.innerHTML = '';
            
            // Clear existing chart lines
            levelLines.forEach((line, index) => {
                try {
                    candlestickSeries.removePriceLine(line);
                    log(LogLevel.DEBUG, `Removed price line ${index}`);
                } catch (e) {
                    log(LogLevel.WARNING, `Failed to remove price line ${index}`, e);
                }
            });
            levelLines = [];
            
            if (!levels || (!levels.resistance?.length && !levels.support?.length)) {
                log(LogLevel.WARNING, 'No levels data available');
                resistanceContainer.innerHTML = '<div style="color: #8892a6; text-align: center; padding: 20px;">No resistance levels found</div>';
                supportContainer.innerHTML = '<div style="color: #8892a6; text-align: center; padding: 20px;">No support levels found</div>';
                return;
            }
            
            // Process resistance levels
            if (levels.resistance && levels.resistance.length > 0) {
                log(LogLevel.INFO, `Processing ${levels.resistance.length} resistance levels`);
                
                levels.resistance.slice(0, 5).forEach((level, index) => {
                    // Add to chart if indicator is active
                    if (indicators.levels && candlestickSeries) {
                        try {
                            const priceLine = candlestickSeries.createPriceLine({
                                price: level.price,
                                color: '#ff3860',
                                lineWidth: 1,
                                lineStyle: LightweightCharts.LineStyle.Dashed,
                                axisLabelVisible: true,
                                title: ''
                            });
                            levelLines.push(priceLine);
                            log(LogLevel.DEBUG, `Added resistance line R${index + 1} at ${level.price}`);
                        } catch (e) {
                            log(LogLevel.ERROR, `Failed to add resistance line R${index + 1}`, e);
                        }
                    }
                    
                    // Add to sidebar
                    const levelElement = document.createElement('div');
                    levelElement.className = 'level-item resistance-level';
                    levelElement.innerHTML = `
                        <span class="level-label">R${index + 1}</span>
                        <span class="level-price">${level.price.toFixed(5)}</span>
                    `;
                    resistanceContainer.appendChild(levelElement);
                });
            } else {
                resistanceContainer.innerHTML = '<div style="color: #8892a6; text-align: center; padding: 20px;">No resistance levels found</div>';
            }
            
            // Process support levels
            if (levels.support && levels.support.length > 0) {
                log(LogLevel.INFO, `Processing ${levels.support.length} support levels`);
                
                levels.support.slice(0, 5).forEach((level, index) => {
                    // Add to chart if indicator is active
                    if (indicators.levels && candlestickSeries) {
                        try {
                            const priceLine = candlestickSeries.createPriceLine({
                                price: level.price,
                                color: '#00ff88',
                                lineWidth: 1,
                                lineStyle: LightweightCharts.LineStyle.Dashed,
                                axisLabelVisible: true,
                                title: ''
                            });
                            levelLines.push(priceLine);
                            log(LogLevel.DEBUG, `Added support line S${index + 1} at ${level.price}`);
                        } catch (e) {
                            log(LogLevel.ERROR, `Failed to add support line S${index + 1}`, e);
                        }
                    }
                    
                    // Add to sidebar
                    const levelElement = document.createElement('div');
                    levelElement.className = 'level-item support-level';
                    levelElement.innerHTML = `
                        <span class="level-label">S${index + 1}</span>
                        <span class="level-price">${level.price.toFixed(5)}</span>
                    `;
                    supportContainer.appendChild(levelElement);
                });
            } else {
                supportContainer.innerHTML = '<div style="color: #8892a6; text-align: center; padding: 20px;">No support levels found</div>';
            }
            
            log(LogLevel.SUCCESS, `Updated levels - ${levelLines.length} lines on chart`);
        }
        
        // ============================================
        // UI UPDATE FUNCTIONS
        // ============================================
        
        function updatePrice(price) {
            log(LogLevel.DEBUG, `Updating current price: ${price}`);
            document.getElementById('currentPrice').textContent = price.toFixed(5);
        }
        
        function updatePrediction(prediction) {
            log(LogLevel.DEBUG, 'Updating ML prediction', prediction);
            
            const actionElement = document.getElementById('predictionAction');
            const confidenceElement = document.getElementById('confidenceValue');
            const confidenceFill = document.getElementById('confidenceFill');
            
            actionElement.textContent = prediction.action;
            actionElement.className = 'prediction-value';
            
            if (prediction.action === 'BUY') {
                actionElement.classList.add('prediction-buy');
            } else if (prediction.action === 'SELL') {
                actionElement.classList.add('prediction-sell');
            } else {
                actionElement.classList.add('prediction-hold');
            }
            
            confidenceElement.textContent = prediction.confidence.toFixed(1);
            confidenceFill.style.width = prediction.confidence + '%';
        }
        
        function updateFundamentals(events) {
            log(LogLevel.DEBUG, `Updating ${events.length} fundamental events`);
            
            const container = document.getElementById('fundamentalEvents');
            container.innerHTML = '';
            
            events.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = `event-item event-${event.impact}`;
                eventElement.innerHTML = `
                    <div class="event-header">
                        <span class="event-title">${event.title}</span>
                        <span class="impact-badge impact-${event.impact}">${event.impact}</span>
                    </div>
                    <div class="event-details">
                        ${event.time} • ${event.currency}<br>
                        Expected: ${event.expected} • Previous: ${event.previous}
                    </div>
                `;
                container.appendChild(eventElement);
            });
        }
        
        function showError(message) {
            log(LogLevel.ERROR, `Showing error: ${message}`);
            
            const chartContainer = document.getElementById('chart');
            if (!candlestickSeries) {
                chartContainer.innerHTML = `<div class="error">${message}</div>`;
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.className = 'status-indicator status-connected';
                statusElement.innerHTML = '<span style="font-size: 10px;">●</span> Connected';
            } else {
                statusElement.className = 'status-indicator status-disconnected';
                statusElement.innerHTML = '<span style="font-size: 10px;">●</span> Disconnected';
            }
        }
        
        // ============================================
        // DATA FETCHING
        // ============================================
        
        async function fetchData() {
            const startTime = Date.now();
            log(LogLevel.INFO, `Fetching data for ${currentSymbol} ${currentTimeframe}M`);
            
            try {
                const response = await fetch(`/api/data?symbol=${currentSymbol}&timeframe=${currentTimeframe}`);
                const data = await response.json();
                
                const fetchTime = Date.now() - startTime;
                log(LogLevel.INFO, `Data fetched in ${fetchTime}ms`);
                
                // Store for debugging
                lastApiResponse = data;
                
                if (data.success) {
                    log(LogLevel.SUCCESS, 'API request successful');
                    updateConnectionStatus(true);
                    
                    // Process each data component
                    if (data.ohlc && data.ohlc.length > 0) {
                        log(LogLevel.INFO, `Received ${data.ohlc.length} OHLC candles`);
                        updateChart(data.ohlc);
                    } else {
                        log(LogLevel.WARNING, 'No OHLC data in response');
                    }
                    
                    if (data.levels) {
                        log(LogLevel.INFO, 'Received levels data', {
                            resistance: data.levels.resistance?.length || 0,
                            support: data.levels.support?.length || 0
                        });
                        updateLevels(data.levels);
                    }
                    
                    if (data.currentPrice) {
                        updatePrice(data.currentPrice);
                    }
                    
                    if (data.prediction) {
                        updatePrediction(data.prediction);
                    }
                    
                    if (data.fundamentals) {
                        updateFundamentals(data.fundamentals);
                    }
                    
                    successCount++;
                } else {
                    log(LogLevel.ERROR, 'API request failed', data.error);
                    showError(data.error || 'Failed to fetch data');
                    errorCount++;
                }
                
            } catch (error) {
                log(LogLevel.ERROR, 'Network error', error);
                showError('Connection error. Please check server.');
                updateConnectionStatus(false);
                errorCount++;
            }
            
            updateDebugPanel();
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        document.getElementById('symbolSelect').addEventListener('change', (e) => {
            currentSymbol = e.target.value;
            isFirstLoad = true;
            lastDataTimestamp = null;
            log(LogLevel.INFO, `Symbol changed to ${currentSymbol}`);
            fetchData();
        });
        
        document.getElementById('timeframeSelect').addEventListener('change', (e) => {
            currentTimeframe = parseInt(e.target.value);
            isFirstLoad = true;
            lastDataTimestamp = null;
            log(LogLevel.INFO, `Timeframe changed to ${currentTimeframe}M`);
            fetchData();
        });
        
        // Indicator toggles
        document.querySelectorAll('.indicator-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const indicator = e.target.dataset.indicator;
                indicators[indicator] = !indicators[indicator];
                e.target.classList.toggle('active');
                
                log(LogLevel.INFO, `Indicator ${indicator} toggled to ${indicators[indicator]}`);
                
                // Re-fetch data to update indicators
                fetchData();
            });
        });
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        window.addEventListener('load', async () => {
            log(LogLevel.INFO, '=== PAGE LOADED - INITIALIZING TRADING SYSTEM ===');
            log(LogLevel.INFO, `Debug mode: ${DEBUG_MODE ? 'ENABLED' : 'DISABLED'}`);
            
            // Show/hide debug panel based on preference
            if (DEBUG_MODE) {
                const hidden = localStorage.getItem('DEBUG_PANEL_HIDDEN') === 'true';
                if (hidden) {
                    document.getElementById('debugPanel').classList.add('hidden');
                }
            } else {
                document.getElementById('debugPanel').classList.add('hidden');
            }
            
            // Check server connection
            try {
                log(LogLevel.INFO, 'Checking server connection...');
                const debugResponse = await fetch('/api/debug');
                const debugData = await debugResponse.json();
                log(LogLevel.SUCCESS, 'Server connection established', debugData);
            } catch (e) {
                log(LogLevel.ERROR, 'Cannot reach server', e);
            }
            
            // Initialize chart
            initializeChart();
            
            // Fetch initial data
            await fetchData();
            
            // Set up auto-update
            updateInterval = setInterval(() => {
                log(LogLevel.DEBUG, 'Auto-update triggered');
                fetchData();
            }, 5000);
            
            log(LogLevel.SUCCESS, 'Trading system initialization complete');
        });
        
        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
                log(LogLevel.INFO, 'Cleared update interval');
            }
        });
        
        // Log keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                const debugPanel = document.getElementById('debugPanel');
                debugPanel.classList.toggle('hidden');
                log(LogLevel.INFO, 'Debug panel toggled via keyboard shortcut');
            }
        });
    </script>
</body>
</html>